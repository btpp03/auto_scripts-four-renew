name: ğŸ”„ KataBump Auto Renew

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    # åŒ—äº¬æ—¶é—´ 10:23 å¯¹åº” UTC 02:23
    - cron: "23 2 * * *"

# æƒé™é…ç½®ï¼šå…è®¸æäº¤å’Œæ¨é€æ›´æ”¹
permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PROJECT_DIR: katabump_code
      SCRIPT_NAME: kataBump_renew_batch.py
      SCRIPT_DESC: KataBump ç»­æœŸè„šæœ¬

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºå½“å‰å…¬å¼€ä»“åº“
      - name: ğŸ“¥ æ£€å‡ºå…¬å¼€ä»“åº“
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: æ£€å‡ºç§æœ‰ä»“åº“ (æ”¾ç½®åœ¨æŒ‡å®šçš„ PROJECT_DIR ç›®å½•ä¸‹)
      - name: ğŸ” æ£€å‡ºç§æœ‰ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: jyucoeng/auto_kataBump_private
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: main
          path: ${{ env.PROJECT_DIR }}
          persist-credentials: true

      # æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: "${{ env.PROJECT_DIR }}/requirements.txt"

      # æ­¥éª¤ 4: å®‰è£…ç³»ç»Ÿä¾èµ–
      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb fonts-noto-cjk fonts-noto-cjk-extra

      # æ­¥éª¤ 5: å®‰è£… Python ä¾èµ–
      - name: ğŸ“š å®‰è£… Python ä¾èµ–
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ æœªæ‰¾åˆ° requirements.txtï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
          fi
        working-directory: ${{ env.PROJECT_DIR }}

      # æ­¥éª¤ 5.5: å®‰è£… Playwright æµè§ˆå™¨
      - name: ğŸŒ å®‰è£… Playwright æµè§ˆå™¨
        run: |
          python -m playwright install chromium
        working-directory: ${{ env.PROJECT_DIR }}

      # æ­¥éª¤ 6: æ·»åŠ éšæœºå»¶è¿Ÿ (é˜²æ­¢å¹¶å‘æ£€æµ‹)
      - name: â³ æ·»åŠ éšæœºå»¶è¿Ÿ
        run: |
          delay=$((RANDOM % 120))
          echo "éšæœºå»¶è¿Ÿ: ${delay}ç§’"
          sleep $delay

      # æ­¥éª¤ 7: æ‰§è¡Œè„šæœ¬
      - name: ğŸš€ æ‰§è¡Œ ${{ env.SCRIPT_DESC }}
        env:
          KATABUMP_BATCH: ${{ secrets.KATABUMP_ACCOUNTS_BATCH }}
        run: |
          xvfb-run -a python ${{ env.SCRIPT_NAME }}
        working-directory: ${{ env.PROJECT_DIR }}

      # æ­¥éª¤ 8: ä¸Šä¼ æˆªå›¾ (ç”¨äºæ’æŸ¥é”™è¯¯)
      - name: ğŸ“¸ ä¸Šä¼ æˆªå›¾åˆ° Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: katabump-screenshots
          path: ${{ env.PROJECT_DIR }}/screenshots
          retention-days: 7
          if-no-files-found: warn

      # æ­¥éª¤ 10: æäº¤æ›´æ–°æ—¶é—´åˆ°å½“å‰å…¬å¼€ä»“åº“
      - name: ğŸ•’ æäº¤æ›´æ–°æ—¶é—´åˆ°å…¬å¼€åº“
        if: always()
        env:
          # ä½¿ç”¨ Token ç¡®ä¿æ¨é€æƒé™
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # ç¡®ä¿å›åˆ°å…¬å¼€ä»“åº“æ ¹ç›®å½•
          cd $GITHUB_WORKSPACE
          
          mkdir -p katabump
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          echo "$TIMESTAMP" > katabump/time.txt
          
          git add katabump/time.txt
          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "ğŸ•’ æ›´æ–° katabump æ—¶é—´æ–‡ä»¶: $TIMESTAMP"
            # ä½¿ç”¨åŒ…å« Token çš„è¿œç¨‹åœ°å€è¿›è¡Œæ¨é€ï¼Œå½»åº•è§£å†³è®¤è¯é—®é¢˜
            git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
            git push origin HEAD:main
            echo "âœ… æ›´æ”¹å·²æ¨é€"
          fi
